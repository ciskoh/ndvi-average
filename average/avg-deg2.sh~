#!/bin/bash
set -o nounset
set +e

set -e


r.mask -r||true	

g.remove -f type=rast pattern=fin*,deg*,temp*

########################################################################3
# Part of the script that analyses the variance in NDVI to evaluate degradation
#comes after Vegetation Potential calculation 
#made in March 2016 for Grass 7 by Matteo Jucker Riva matteo.jucker@cde.unibe.ch 
###########################################################################

# Degradation evaluation mode 2: First images are merged with AVERAGE, then Degradation is calculated based on q90


r.mask -r||true	

		
if [ "$VPtype" = "2" ]; then #if for detrmining which type of evaluation should be done


	#obtain list of categories and images
	lsv=$(r.stats -n input=$landscape) #list of all categories in landscape map	
	nlist=$(g.list type=rast pattern=ndvi* separator=space) #list of ndvi images	


	#merging of NDVI images with AVERAGE
	
	nlist2=`echo $nlist | tr " " ","`	#adding commas between list of NDVI images
	r.series --overwrite input=$nlist2 output=averagendvi method=average	#Merging all the maps in NDVI

	#starting cyle for variance analysis
	
	dcount=0
	echo "dcount is $dcount"
	for a in $lsv; do	#cycle through landscape categories
		
				
		
		echo "
		***************************************************
		starting cycle 
		for analysis of degradation with method 2
		Linear Q90
		working on category $a
		*****************************************************" 
		r.mask --overwrite --verbose raster=$landscape maskcats=$a	#mask for present category
		x=`r.univar -g --quiet map=MASK`
		echo " mask is $x
all ok?"
#read ok
		VP=${genvp[$dcount]}		# value of VP for present category
		min=${arraymin[$dcount]}	# value of min for present category
		max=${arraymax[$dcount]}

		VP=$(echo "($VP+0.5)/1" | bc)

		b1=$(echo "($VP*0.25)/1" | bc )    # boundary 1 ( VD / Deg )
		b2=$(echo "($VP*0.5)/1" | bc)    # boundary 2 ( Deg / Semidegraded )
		b3=$(echo "($b2 + $b1)/1" | bc)   # boundary 3 ( Semidegraded / Healthy )
				
		echo "min is $min, max is $max, VP is $VP, b3 is $b3"
		#read ok
		echo "$min thru $b1 = 1" >/tmp/rules.txt
		echo "$b1 thru $b2 = 2" >>/tmp/rules.txt
		echo "$b2 thru $b3 = 3" >>/tmp/rules.txt
		echo "$b3 thru $VP = 4" >>/tmp/rules.txt
		echo "$VP thru $max = 5" >>/tmp/rules.txt


		r.reclass input=averagendvi output=deg.$a rules=/tmp/rules.txt
				
		echo "min is $min, max is $max, VP is $VP"
		#read ok
		


		#dividing final map for category according to degradation classes
		r.mapcalc --overwrite file=- <<EOF
		tempdeg1 = deg.$a<25
		tempdeg2 = deg.$a<50 	
		tempdeg3 = deg.$a<75 	
		tempdeg4 = deg.$a<100 		
		tempdeg5 = deg.$a=100 	
EOF

		#getting cell count for each category of degradation
		c1=$(r.univar -g --quiet map=tempdeg1)	#get cell count for Very degraded
		cc1=`echo $c1 | rev | cut -d= -f1 | rev`	#clean cell count string Very degraded
		
		c2=$(r.univar -g --quiet map=tempdeg2)	#get cell count for Degraded
		cc2=`echo $c2 | rev | cut -d= -f1 | rev`	#clean cell count string Degraded
		
		c3=$(r.univar -g --quiet map=tempdeg3)	#get cell count for Semi degraded
		cc3=`echo $c3 | rev | cut -d= -f1 | rev`	#clean cell count string Semi degraded

		c4=$(r.univar -g --quiet map=tempdeg4)	#get cell count for healthy
		cc4=`echo $c4 | rev | cut -d= -f1 | rev`	#clean cell count string healthy

		c5=$(r.univar -g --quiet map=tempdeg5)	#get cell count for PV
		cc5=`echo $c5 | rev | cut -d= -f1 | rev`	#clean PV
		
		
		tot=$((cc1+cc2+cc3+cc4+cc5))	#clean cell count for the whole category
		
		#dividing category for stats file
		lu=$((a/100))	#land use
		slope=$(((a/10)-(lu*10)))	#slope
		aspect=$((a-(lu*100)-(slope*10)))	#aspects
			
				
		echo "$a;$lu;$slope;$aspect;$min;$max;$VP;$cc1;$cc2;$cc3;$cc4;$cc5;$tot" >>$vlist
		#read ok
		
		r.mask -r||true
		
		dcount=$((dcount+1))
		
		
		
	done
	r.mask --overwrite raster=$landscape	
	
	#merging final maps in one big final map
	finl=$(g.list type=rast pattern=deg.*)	#getting list of final images to merge
	finl=`echo $finl | tr " " ","` 	#cleaning list of final maps
	echo "check finals map $finl"
	#read ok
	r.patch input=$finl output=final_$antype #actual merging of degradation maps for single categories
	d.mon stop=wx0||true
	
	#exporting final map
	
	r.out.gdal input=final_$antype output=$foldout2/final_$antype".tif" format=GTiff
		
	g.remove -f type=rast pattern=deg.*,temp*
		
		
fi

