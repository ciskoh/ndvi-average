#!/bin/bash

set -o nounset

#script that calculates classes of variance through multiple ndvi images using yearly quantiles and average pixel value
#input: surface reflectance derived ndvi images, 
#Variance-avg calculates quantiles over the all year average and compares to monthly images
#modified for averaging pixel values in final map and added yearly quantile in stats

echo "test"
read ok


##obtain list of category values
#lsv=$(r.stats -n input=$basemap)
#echo "test"
#read ok

#echo "this is lsv: $lsv"

#read ok

##starting cycle for each category

#echo "

#***************************************************
#starting cycle 
#for quantiles calculations and co.


#*****************************************************" 
#r.mask -r
#scount=0

##creating average map including all images *PART MODIFIED FROM PREVIOUS SCRIPT*
#nlist2=$(g.mlist type=rast pattern=corr* separator=comma)
#echo "nlist2 is $nlist2"
#read ok
#r.series --overwrite input=$nlist2 output=yearly-avg method=average

#echo "test???????"
#read ok

#for g in $lsv ;
#do

#	echo "calculating quantiles for category $g"
#	read ok
#	#creating mask for category $g
#	echo "creating mask for category $g"
#	r.mask -o input=$basemap maskcats=$g
#	read ok
#	nlist=$(g.mlist type=rast pattern=corr*)
#	nlist2=$(g.mlist type=rast pattern=corr* separator=comma)
#	#creating output folder
#	mkdir -p $foldout2/statistics
#	mkdir -p $foldout2/rasters
#	#TODO change potential calculation from yearly mean to single frame 
#	#calculation of year round 90th quantile
#	if [[ scount -eq "0" ]]; then #if for creating folder for statistics
#			mkdir -p $foldout2/category_stats
#			
#		fi
#		mkdir -p $foldout2/category_stats/$g #

#	#calculation of statistics
#	r.univar -e map=yearly-avg percentile=25,50,75,90,2 >$foldout2/category_stats/$g-yearly-stats.txt

#	echo "check $foldout2/category_stats/$g-yearly-stats.txt"
#	#####read ok
#	#identifying 90th quantile / Vegetation potential
#	mpath=$foldout2/category_stats/$g-yearly-stats.txt #path to yearly stats
#	p90a=$(sed -n '22p' < $mpath)

#	p90=${p90a#*:}

#	yquant=$(echo "$p90*1000" | bc -l)
#	echo "quantile calculated for landscape area $g: value is: $yquant !!!"
#	read ok

#	r.mask -r
#	
#	#creating images from Yearly average image for present category *PART changed from previous script*
#	##normalised ndvi maps using all year step quantile

#	#reducing highest values at 90th quantile
#	str1=$s"temp"
#	r.mapcalc "$str1=if(MASK,float(yearly-avg*100.00),null())"
#	str25=$s"temp2"
#	r.mapcalc "$str25=float(if($str1>$yquant,$yquant,$str1))"
#	
#	r.rescale input=$str25 output=fin_$g to=0,100
#	echo "check $str25 max value should be $yquant

#	and fin_$g as final map"
#	read ok
#	
#	
#	echo "#######################################################

#	CYLE finished for all images on category $g

#	##############################################################"
#	#####read ok 
#	scount=$((scount+1))
#	r.mask -r;

#done


#echo "check mask"

#r.mask -o input=$basemap
######read ok
###Merging all the images together using gdal *pART MODIFIED FROM PREVIOUS SCRIPT*
#finlist=$(g.mlist type=rast pattern=corr* separator=comma)
#echo " final map list is $finlist"
#read ok

##TODO: merge all the finmap together in one image; review what is below here
##dir $foldout2/rasters/*/
######read ok
##for i in $foldout2/rasters/*/; do
##	cd $i
##	nd=$(basename $i)
##	list=$(dir $i)
##	echo "nd is $nd and list is $list"
##	##read ok
##	gdal_merge.py -n 255 -of GTiff -a_nodata 255 -o $foldout2/rasters/final_$nd".tiff" $list
##	echo "merged"
##	##read ok
##	#reimporting all final images per each month
##	r.in.gdal --overwrite input=$foldout2/rasters/final_$nd".tiff" output=$s"_final_"$nd;

##Patching final maps together with r.patch

#r.patch
#r.mask -r


##extracting values from final map
#count=0
#for g in $lsv ;
#do

#	echo "calculating stats category $g"
#	read ok
#	#creating mask for category $g
#	echo "creating mask for category $g"
#	r.mask -o input=$basemap maskcats=$g
#	######read ok
#	
#	if [[ count -eq "0" ]]; then
#		sed -i "1 s/$/ Very-deg; Deg; Semi-Deg; Healthy; Veg-Pot;/" $vlist #adding column titles
#	fi
#	d=$((count+1)) #number of line to use in file lsvalue.csv

#	#extracting different deg categories from final map
#	fin=$s"_final_allyear"
#	r.mapcalc "tempdeg1=$fin<25"
#	r.mapcalc "tempdeg2=$fin>25 && $fin<50"
#	r.mapcalc "tempdeg3=$fin>50 && $fin<75"
#	r.mapcalc "tempdeg4=$fin>75 && $fin<90"
#	r.mapcalc "tempdeg5=$fin>90"
#	
#	
#	#calculating statistics for each deg level and extractin sum of values (pixel count)

#	a=$(r.univar -g --quiet map=tempdeg1)
#	deg1=${a##*sum=}

#	a=$(r.univar -g --quiet map=tempdeg2)
#	deg2=${a##*sum=}

#	a=$(r.univar -g --quiet map=tempdeg3)
#	deg3=${a##*sum=}

#	a=$(r.univar -g --quiet map=tempdeg4)
#	deg4=${a##*sum=}

#	a=$(r.univar -g --quiet map=tempdeg5)
#	deg5=${a##*sum=}
#	sedstrg2="$deg1; $deg2; $deg3; $deg4; $deg5;"
#	echo "check this: $sedstrg2"
#	#read ok
#	sed -i "$d s/$/ $sedstrg2/" $vlist
#	echo "check values for $g in file $vlist line $d; they should be $deg1; $deg2; $deg3; $deg4; $deg5;"

###read ok

#	count=$((count+1))
#done
#r.mask -r 

##exporting final maps
#r.out.gdal input=$s"_final_allyear" output=/$foldout/rasters/$s"_final_allyear.tiff" nodata=255



echo "
############
##############
#################

VARIANCE.SH IS FINISHED!!!!
GOING BACK TO LMS-AN.SH

#################
###############
############
"



